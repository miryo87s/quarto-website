{
  "hash": "1f9e4533370cd0287036c39eeffc807b",
  "result": {
    "markdown": "---\ntitle: \"Small Tricks in Linear Regression\"\ndescription: \"I am using this post as a memo for some tricks in linear regressions.\"\nabstract: >\n  This is a memo of some tricks I found/learned in linear regressions.\ndate: \"2022-10-02\"\ncategories:\n  - memo\ncode-fold: false\n---\n\n::: {.cell}\n\n:::\n\n\n# Estimates and SE of Some Sample Mean\n\nSometimes we are interested in statistics $\\theta$ that can be estimated by the sample mean of some function\n\n$$\n\\hat\\theta = \\frac1n \\sum_i f(W_i)\n$$\n\nFor example, $\\hat\\theta$ is the MSE of a predictor $\\hat{g}(X_i)$ of $\\mathbb{E}[Y_i|X_i]$\n\n$$\n\\hat\\theta = \\frac1n \\sum_i (Y_i - \\hat{g}(X_i))^2\n$$\n\nwith $f(W_i) = (Y_i - \\hat{g}(X_i))^2$.\n\nCalculating $\\hat\\theta$ is simple but obtaining the standard error of $\\hat\\theta$ requires extra efforts. In this case, we can utilize the convenient linear regression functions in statistical softwares. The sample mean of some function $f(W_i)$ is equivalent to regressing $f(W_i)$ on a vector of $1$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1)\n\nn <- 1000\nX <- rnorm(n)\nY <- 1 + 2 * X + rnorm(n)\n\nmod <- lm(Y ~ X)\ngX <- mod$fitted.values\n\n# MSE by sample mean \nmse <- mean((Y - gX)^2)\ncat(\"The MSE of gX is\", mse)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nThe MSE of gX is 1.080436\n```\n:::\n\n```{.r .cell-code}\n# MSE by linear regression\nmse.lm <- lm((Y - gX)^2 ~ 1) |> summary()\ncat(\"The MSE of gX by linear regression is\", mse.lm$coef[1], \"with SE\", mse.lm$coef[2])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nThe MSE of gX by linear regression is 1.080436 with SE 0.04810917\n```\n:::\n:::\n\n\nBy this linear regression trick, we can easily obtain $\\hat\\theta$ and its standard error. The estimator by linear regression is equivalent to the sample mean and is always consistent. However, if there is an estimator in $f(W_i)$ such as $\\hat{g}(X_i)$ in the MSE example, to ensure the standard error is correct, we need $f(W_i)$ to satisfy\n\n$$\n\\mathbb{E}[\\partial_\\gamma f(W_i)] = 0\n$$ {#eq-ortho}\n\nwhere $\\gamma$ is the parameter in $g(X_i)$ with $\\hat{g}(X_i) = g(X_i, \\hat\\gamma)$. This is because we need to take into account the estimation error in $\\hat{g}(X_i)$ when calculating the standard error of $\\hat\\theta$, but this estimation error does not affect $f(W_i)$ if @eq-ortho is satisfied (partial derivative is 0).\n\nIn the MSE example, $\\hat{g}(X_i) = X_i\\hat\\gamma$ and $f(W_i) = (Y_i - X_i\\gamma)^2$. Then\n\n$$\n\\mathbb{E}[\\partial_\\gamma f(W_i)] = \\mathbb{E}[-X_i'(Y_i - X_i\\gamma)] = 0\n$$\n\nby the exogeneity of $X$. So the standard error in the MSE example is correct.\n\n# Multiple regression at one\n\nSometimes, we may want to compare coefficients in two different regressions. In this case, a formal hypothesis test is hard to implement because we need a variance-covariance matrix of the coefficients in different regressions. One easy solution is to trick statistical softwares to run two regression at one time by stacking the two regressions.\n\nSuppose we want to compare the coefficients $\\alpha$ and $\\beta$ in regressions\n\n$$\nY = X\\alpha + \\epsilon, \\quad \\quad Z = D\\beta + \\nu\n$$\n\nWe can stack the two samples and obtain a long response variable $(Y', Z')'$ and a large design matrix\n\n$$\n\\begin{pmatrix}\nX & 0 \\\\\n0 & D\n\\end{pmatrix}\n$$\n\nso that we have\n\n$$\n\\begin{pmatrix} Y \\\\ Z \\end{pmatrix} = \\begin{pmatrix} X & 0 \\\\ 0 & D \\end{pmatrix} \\begin{pmatrix} \\alpha \\\\ \\beta \\end{pmatrix} + \\begin{pmatrix} \\epsilon \\\\ \\nu \\end{pmatrix}\n$$\n\nBy running this stacked regression, we are able to obtain the variance-covariance matrix of $\\hat\\alpha$ and $\\hat\\beta$, which is essential to conduct hypothesis tests on $\\alpha$ and $\\beta$.\n\nOne advantage of this method is that, using stacked regression, we can recover the OLS estimates of $\\alpha$ and $\\beta$ in the separate regressions (Seemingly Unrelated Regression can do the same task but cannot always recover OLS estimates). **Note clustered standard error is recommended for the stacked regression** and this method can be extended to IV regressions (or a combination of IV and OLS) by regarding OLS as a special case of IV where the regressors are instrumented by themselves. Below is an example using the dataset of High School and Beyond survey.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhsb2 <- foreign::read.dta(\"https://stats.idre.ucla.edu/stat/stata/notes/hsb2.dta\")\nhsb2$female <- ifelse(hsb2$female == \"female\", 1, 0)\nhsb2$ses <- as.numeric(hsb2$ses)\n\n# Separate regressions\nsummary(lm(read ~ female + ses + socst, data = hsb2))$coef[2, 1:2]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  Estimate Std. Error \n -1.511128   1.151079 \n```\n:::\n\n```{.r .cell-code}\nsummary(lm(math ~ female + ses + science, data = hsb2))$coef[2, 1:2]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  Estimate Std. Error \n  1.160903   1.041641 \n```\n:::\n\n```{.r .cell-code}\n# Stacked regression\nread.math <- with(hsb2, c(read, math))\nX <- cbind(hsb2 |> select(\"female\", \"ses\", \"socst\"), matrix(rep(0, nrow(hsb2) * 3), nrow(hsb2), 3))\nD <- cbind(matrix(rep(0, nrow(hsb2) * 3), nrow(hsb2), 3), hsb2 |> select(\"female\", \"ses\", \"science\"))\ndf <- data.frame(read.math, rbind(as.matrix(X), as.matrix(D))) |> \n  setNames(c(\"rm\", \"female.r\", \"ses.r\", \"socst\", \"female.m\", \"ses.m\", \"science\"))\ndf$sid <- c(rep(1, nrow(hsb2)), rep(0, nrow(hsb2)))\n\nstacked <- lm(rm ~ ., data = df)\nvcov(stacked, type = \"const\", cluster = c(rep(1, nrow(hsb2)), rep(0, nrow(hsb2))))[c(2, 5), c(2, 5)]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             female.r     female.m\nfemale.r 1.205347e+00 2.701477e-15\nfemale.m 2.701477e-15 1.204577e+00\n```\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}